<?xml version="1.0" encoding="UTF-8"?>
<!-- edited with XMLSPY v5 U (http://www.xmlspy.com) by et8 (et8) -->
<!-- edited with XML Spy v4.2 U (http://www.xmlspy.com) by Kiushan Pirzadeh (Visa) kpirzade@visa.com -->
<ApplicationProfile Name="hbnative" ProfileVersion="1.0.0" UniqueID="00001AAAAA" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="GP ApplicationProfile.xsd">
	<Revisions>
		<Revision By="Kiushan Pirzadeh" Date="2002-02-13" Digest="0000" ProfileID="00001AAAAA" Time="15:54:00" Version="1.0.0"/>
	</Revisions>
	<ConflictRules>
		<!-- Ensure enough memory is on the card -->
		<!-- Make sure memory units are in bytes -->
		<ConflictRule Rule="==" Source="CardProfile.CardManufacturerProduct.Chip.ResourcesAvailable.Unit" Target="bytes"/>
		<!-- Check amount of RAM on the card -->
		<ConflictRule Rule="&gt;=" Source="CardProfile.CardManufacturerProduct.Chip.ResourcesAvailable.RAM" Target="0"/>
		<!-- Check amount of EEPROM on the card -->
		<ConflictRule Rule="&gt;=" Source="CardProfile.CardManufacturerProduct.Chip.ResourcesAvailable.EEPROM" Target="0"/>
		<!-- Check amount of Flash on the card -->
		<ConflictRule Rule="&gt;=" Source="CardProfile.CardManufacturerProduct.Chip.ResourcesAvailable.Flash" Target="0"/>
		<!-- Ensure card is a Java card -->
		<ConflictRule Rule="==" Source="CardProfile.CardManufacturerProduct.Platform.Type" Target="JAVA"/>
		<!-- Ensure card is a GP card -->
		<ConflictRule Rule="==" Source="CardProfile.CardManufacturerProduct.Platform.OSPlatform" Target="GP"/>
		<ConflictRule Rule="==" Source="CardProfile.CardManufacturerProduct.Platform.OSVersion" Target="2.0.1"/>
	</ConflictRules>
	<ApplicationInfo Developer="KP" Domain="Tool" NonVolatileDataSpaceMin="4096" Owner="GlobalPlatform" Provider="GP" SubType="CM" Type="OP" Version="0.0.1" VolatileDataSpaceMin="100">
		<Privileges/>
		<LifeCycles>
			<LifeCycle Name="pre_PersoPrep"/>
			<LifeCycle Name="post_PersoPrep"/>
			<LifeCycle Name="INSTALLED" Value="01"/>
			<LifeCycle Name="OP_READY" Value="01"/>
			<LifeCycle Name="SELECTABLE" Value="03"/>
			<LifeCycle Name="INITIALIZED" Value="07"/>
			<LifeCycle Name="PERSONALIZED" Value="0F"/>
			<LifeCycle Name="SECURED" Value="0F"/>
			<LifeCycle Name="CARD_LOCKED" Value="7F"/>
			<LifeCycle Name="TERMINATED" Value="FF"/>
		</LifeCycles>
		<Codes>
			<Code ModuleID="0000100001"/>
		</Codes>
	</ApplicationInfo>


	
	<Key External="false" Name="KSCmac" ProfileID=""/>
	<Key External="false" Name="KSCenc" ProfileID=""/>
	<Key External="false" Name="KSCkek" ProfileID=""/>
	<Key External="false" Name="CDKenc" ProfileID=""/>
	<Key External="false" Name="CDKmac" ProfileID=""/>
	<Key External="false" Name="CDKkek" ProfileID=""/>
	<Key External="false" Name="KMU" ProfileID=""/>
	<Key External="false" Name="BANKKEK" ProfileID=""/>
	<Key External="true" Name="KMC" ProfileID="A000000000008762"/>
	<Key External="true" Name="MSK" ProfileID="A000000000008801"/>

	



	 <NormalParater dataTypeVersion="1" name="dataType" value="8"/> 	
	<!--0:Normal DataPrepare 1:Geer Data DataPrepare 2:unionPay data DataPrepare 3:huatengdata DataPrepare 6:CMBChina-->  
	<NormalParater name="Base64DecodeTag" value=""/>
	<NormalParater name="BlankTo20Tag" value=""/>
	<NormalParater name="DgiWithoutTag" value="9000|9010|8010|8000|8201|8202|8203|8204|8205|0101|0102|0201|0202|0203|0204|0205|0206|0301|0302|0401|0501|9102|9104|9203|9200"/>//union data

	
	<DecryptTags>
  		<DecryptTag mech="ECB" name="BANKKEK" value=""/>    
  	</DecryptTags>

	
<CustomParater name="lastDgi" value="9207"/> 

	<!-- created in programe -->
	<!-- the last 2 AID will be supplied as an external data element per card, used when derive CMK and replace Key -->
	<DataElement Encoding="HEX" External="true" FixedLength="true" Length="9" Name="AID" ReadWrite="true" Type="BYTESTRING" Update="true"/>
	<!-- CSN will be supplied as an external data element per card, used when derive CMK and replace Key -->
	<DataElement Encoding="HEX" External="true" FixedLength="true" Length="9" Name="CSN" ReadWrite="true" Type="BYTESTRING" Update="true"/>
	<DataElement Encoding="HEX" External="true" FixedLength="false" Name="issuerIIN" Tag="0042" TagEncoding="EMV" Type="BYTESTRING" Update="false"/>
	<!-- the Tag which indicate wether KMC was supplied in card -->
	<DataElement Encoding="HEX" External="true" FixedLength="false" Name="KMC_TAG" Tag="0042" TagEncoding="EMV" Type="BOOLEAN" Update="false"/>
	<!-- the dgi data element -->
	<DataElement Encoding="HEX" External="false" FixedLength="false" Name="BIN" Type="BYTESTRING" Update="false" Value="11223344"/>	
	<DataElement Encoding="HEX" External="true" Name="CPS_Output" Optional="false" ReadWrite="true" Type="BYTESTRING" Update="true"/>	
	<DataElement Encoding="HEX" External="true" Name="PPSE_CPS_Output" Optional="false" ReadWrite="true" Type="BYTESTRING" Update="true"/>
	<DataElement Encoding="HEX" External="true" Name="PSE_CPS_Output" Optional="false" ReadWrite="true" Type="BYTESTRING" Update="true"/>		
	<DataElement Encoding="HEX" External="true" Name="PAN" Optional="false" ReadWrite="true" Type="BYTESTRING" Update="true"/>	


	<DataElement Encoding="HEX" External="true" Name="dgi0101" Optional="true" Type="BYTESTRING"/>
	<DataElement Encoding="HEX" External="true" Name="dgi0102" Optional="true" Type="BYTESTRING"/>
	<DataElement Encoding="HEX" External="true" Name="dgi0201" Optional="true" Type="BYTESTRING"/>
	<DataElement Encoding="HEX" External="true" Name="dgi0202" Optional="true" Type="BYTESTRING"/>
	<DataElement Encoding="HEX" External="true" Name="dgi0203" Optional="true" Type="BYTESTRING"/>
	<DataElement Encoding="HEX" External="true" Name="dgi0204" Optional="true" Type="BYTESTRING"/>
	<DataElement Encoding="HEX" External="true" Name="dgi0205" Optional="true" Type="BYTESTRING"/>
	<DataElement Encoding="HEX" External="true" Name="dgi0206" Optional="true" Type="BYTESTRING"/>

	<DataElement Encoding="HEX" External="true" Name="dgi0301" Optional="true" Type="BYTESTRING"/>
	<DataElement Encoding="HEX" External="true" Name="dgi0302" Optional="true" Type="BYTESTRING"/>

	<DataElement Encoding="HEX" External="true" Name="dgi0401" Optional="true" Type="BYTESTRING"/>
	<DataElement Encoding="HEX" External="true" Name="dgi0501" Optional="true" Type="BYTESTRING"/>
		
	<Function Name="appendRecord" Param="dgiTag,dgiLen,dgiValue">
		<Script><![CDATA[
			  dgi = new ByteBuffer();
			  dgi.append(dgiTag);
			  dgi.append(dgiLen);
			  dgi.append(dgiValue);
		      if(dgi!=null)
		      {
          	     this.storeData(dgi.toByteString(),0x00,0x9000,0x00);
          	 }
          	 else
          	 {
          	     GPSystem.trace("this DGI is null");
          	 }
      ]]></Script>
	</Function>
	<Function Name="appendRecord8000and9000" Param="dgi">
		<Script><![CDATA[
			 	  
       this.storeData(dgi,0x00,0x9000,0x00);
          	
      ]]></Script>
	</Function>
	<Function Name="putData" Param="dgi">
		<Script><![CDATA[
		if(dgi!=null)
			{
		         //dgi0702 and dgi0703(only for applete 1.2) are special,because it's been writen partly(TLV940C) when install application
        		 if((dgi.getTag()==0x0702)||(dgi.getTag()==0x0703))
		         {
  	    		    dgiTlvList = new TLVList(dgi.getValue(),EMV);
		  			MyTLV=dgiTlvList.find(0x82);
					this.sendApdu(0x80, 0xDA, 0x00, 0x82, MyTLV.getValue());
		         }
		         else //not 0702, not 0703
        		 {
		         	dgiTlvList = new TLVList(dgi.getValue(),EMV);  //dgi is a byteString
        		 	for(i=0;i< dgiTlvList.length;i++)
		         	{
        		    	 MyTLV=dgiTlvList.index(i);
             			this.sendApdu(0x80, 0xDA, MyTLV.getTag()>>8, MyTLV.getTag() & 0xFF, MyTLV.getValue());
         			}
         		}
         	}
         	else
         	{
         	    GPSystem.trace("this DGI is null");
         	}
      ]]></Script>
	</Function>

	<Function Name="putDESKey" Param="myKey,dgiValue">
		<Script><![CDATA[
   		
                 this.secureChannel.setKekKey(myKey.PSK);
				 //use a special object to get the properties of the application key
                 watchObject=GPSystem.getVendorObject("GPSupport");
				 	version = 0x00;
      			    index = 0x03;
      			    newVersion= 0x01;
      			    type = 0x81;
      			    DES = 0x80

		         if(dgiValue.bytes(0,16).toString()!="00000000000000000000000000000000")
		         {
		         	//UDK  Authentication Key ---"03"
      			    index = 0x03;
      			    myKey.UDK.setComponent(DES,dgiValue.bytes(0,16));
      			    checkValue=myKey.UDK.getKcv();
      			    this.putKey(version,newVersion,index,type,myKey.UDK,checkValue);
		         }
		         if(dgiValue.bytes(16,16).toString()!="00000000000000000000000000000000")
		         {
		       	    //MAC Key --- "02"
      			    index = 0x02;
      			    myKey.MAC.setComponent(DES,dgiValue.bytes(16,16));      			    
      			    checkValue=myKey.MAC.getKcv();
      			    this.putKey(version,newVersion,index,type,myKey.MAC,checkValue);
		         }
		         if(dgiValue.bytes(32,16).toString()!="00000000000000000000000000000000")
		         {
		       	    //ENC Key---"04"
			    index = 0x04;
      			    myKey.ENC.setComponent(DES,dgiValue.bytes(32,16));				 	
      			    checkValue=myKey.ENC.getKcv();
      			    this.putKey(version,newVersion,index,type,myKey.ENC,checkValue);
		         }
      ]]></Script>
	</Function>

	<Function Name="putRSAKey" Param="myKey,dgiTag,dgiValue">
		<Script><![CDATA[
	  			//DGI 8101 8103
  				//DGI 8102 8104
 			  	type=new ByteString("A2",HEX);
	      		//dgi is clear data
    	  		clearKey=dgiValue.pad(Crypto.EMV_PAD);  //L+key+padding
      			keyData = this.crypto.encrypt(myKey.PSK,this.crypto.DES_ECB,clearKey);

	  			comData=new ByteBuffer();
  				if( ((dgiTag & 0XFF)==0x01) || ((dgiTag & 0XFF)==0x03) )
      				 comData.append("02").append(type).append(keyData.getL()).append(keyData);
  				else  //here keyVersion must be 02,can't be 03
      				 comData.append("02").append(type).append(keyData.getL()).append(keyData);

	  			if((dgiTag & 0XFF) > 0x02)  //03,04 is modulus(keyIndex=0x01)
    	  			 this.sendApdu(0X80, 0xD8, 0x00, 0x01,comData.toByteString());  //ICCSK Modulus
  				else // 01,02 is exponent(keyIndex=0x02)
      	 			this.sendApdu(0X80, 0xD8, 0x00, 0x02,comData.toByteString());  //ICCSK Exponent
      ]]></Script>
	</Function>

	
	 <Function Name="nativeDel" Param="myKey,dgiValue">
		<Script><![CDATA[
				     
   			this.card.reset(0x05);	
   			this.securityDomain.select("A0000000030000");	 	  
   			this.openSecureChannel(NO_SECUREITY_LEVEL);	 
 			 this.sendApdu(0X80, 0xE4, 0x00, 0x00,new ByteString("4F0E315041592E5359532E4444463031",HEX)); 
 			 this.sendApdu(0X80, 0xE4, 0x00, 0x00,new ByteString("4F0E325041592E5359532E4444463031",HEX)); 
 			 this.sendApdu(0X80, 0xE4, 0x00, 0x00,new ByteString("4F08A000000333010101",HEX)); 			 
 			  			
   		
               ]]></Script>
	</Function>
	
	 <Function Name="install" Param="myKey,dgiValue">
		<Script><![CDATA[
				     
   			//this.card.reset(0x05);
				this.openSecureChannel(NO_SECUREITY_LEVEL);	 
 			 this.sendApdu(0X80, 0xE6, 0x0C, 0x00,new ByteString("08A00000033310101207A00000033310100E315041592E5359532E4444463031011003C9010300",HEX)); 
 			 this.sendApdu(0X80, 0xE6, 0x0C, 0x00,new ByteString("08A00000033310101207A00000033310100E325041592E5359532E4444463031011003C9010300",HEX)); 
 			 this.sendApdu(0X80, 0xE6, 0x0C, 0x00,new ByteString("08A00000033310101207A000000333101008A000000333010101010003C9010000",HEX)); 
			  			
   		
               ]]></Script>
	</Function>
	
	<Function Name="changePin" Param="myKey,dgiValue">
		<Script><![CDATA[
			  	plainPinData = dgiValue;
			  	out.println("plainPinData="+plainPinData);
				retryCount = plainPinData.bytes(9,1);
	  			encrypedPinData = this.crypto.encrypt(myKey.PSK,Crypto.DES_ECB,plainPinData.left(8));
  				pin = new ByteBuffer(encrypedPinData.left(8));
				this.sendApdu(0x80,0x24, 0x00, retryCount.toUnsigned(),pin.toByteString());			
      ]]></Script>

	</Function>
	<Function Name="endPersonalization" Param="comData">
		<Script><![CDATA[
     		//	this.sendApdu(0x80,0xE2,0x80, 0x0F, comData);
     			this.storeData(comData,0x01,0x9000,0x00);
      ]]></Script>
	</Function>
	
		<Function Name="encryptedBySkudek" Param="comData">
		<Script><![CDATA[
     		//	this.sendApdu(0x80,0xE2,0x60, 0x0F, comData);
     			this.storeData(comData,0x02,0x9000,0x00);
      ]]></Script>
	</Function>
	<Function Name="encryptedPinBySkudek" Param="comData">
		<Script><![CDATA[
     		//	this.sendApdu(0x80,0xE2,0x20, 0x0F, comData);
     			this.storeData(comData,0x03,0x9000,0x00);
      ]]></Script>
	</Function>
	<Function Name="putEncryptedRSA" Param="comData">
		<Script><![CDATA[
     			this.sendApdu(0x80,0xE2,0x60, comData.getL(), comData);
     			//this.storeData(comData,true,0x9000,0x00);
      ]]></Script>
	</Function>

	<Function Name="replaceKDC" Param="myKey,myObject">
		<Script><![CDATA[
			    derivationData = new ByteBuffer();
	            derivationKey = new String();	            
				this.securityDomain.secureChannel.initializeUpdate(0,0);
                watchObject=GPSystem.getVendorObject("GPSupport");
  			GPSystem.trace("finish initupdate ");  			
  			initResp = new ByteBuffer();  			
  			initResp = this.card.response.bytes(4,6);        
        
        //card enc
        derivationData.append(initResp).append("F001").append(initResp).append("0F01");        
				Crypto.deriveKey(this.key["KMC"], Crypto.DES_ECB, derivationData.toByteString(), this.key["KSCenc"]);
        GPSystem.trace("this.key:"+this.key["KSCenc"]);
				// card mac
				derivationData.clear();

				 derivationData.append(initResp).append("F002").append(initResp).append("0F02");        
				Crypto.deriveKey(this.key["KMC"], Crypto.DES_ECB, derivationData.toByteString(), this.key["KSCmac"]);
				 GPSystem.trace("this.key:"+this.key["KSCmac"]);
									

				// card dek
				derivationData.clear();

				 derivationData.append(initResp).append("F003").append(initResp).append("0F03");        
				Crypto.deriveKey(this.key["KMC"], Crypto.DES_ECB, derivationData.toByteString(), this.key["KSCkek"]);					
	       			GPSystem.trace("this.key:"+this.key["KSCkek"]); 
				// Set the keys used by the secure channel - not sure on KEK key assignments
				this.securityDomain.secureChannel.setKekKey(this.key["KSCkek"]);			
				this.securityDomain.secureChannel.setEncKey(this.key["KSCenc"]);
				this.securityDomain.secureChannel.setMacKey(this.key["KSCmac"]);

				//replace the KDC
	      		keyVersion=0x01;
    	  		keyNewVersion=0x01;
      			keyIndex=0x01;
      			//this.securityDomain.putKey(keyVersion,keyNewVersion,keyIndex,0x81,myKey.CDKenc,myKey.CDKenc.getKcv(),0x81,myKey.CDKmac,myKey.CDKmac.getKcv(),0x81,myKey.CDKkek,myKey.CDKkek.getKcv());
      			this.putKey(keyVersion,keyNewVersion,keyIndex,0x81,myKey.CDKenc,myKey.CDKenc.getKcv(),0x81,myKey.CDKmac,myKey.CDKmac.getKcv(),0x81,myKey.CDKkek,myKey.CDKkek.getKcv());

      			//Verify keyVersion and checkValue
      			if(this.card.response.left(1).toUnsigned()!=keyNewVersion)
      				throw Error("key version incrrect");
      			if(!(this.card.response.bytes(1,3).toString()==myKey.CDKenc.getKcv().left(3).toString()))
      				throw Error("CDKenc kcv incorrect");
      			if(!(this.card.response.bytes(1+3,3).toString()==myKey.CDKmac.getKcv().left(3).toString()))
      				throw Error("CDKmac kcv incorrect");
      			if(!(this.card.response.bytes(1+3+3,3).toString()==myKey.CDKkek.getKcv().left(3).toString()))
      				throw Error("CDKkek kcv incorrect");
      ]]></Script>
	</Function>

      <Function Name="psePersonal" Param="pse,ppse">
		<Script><![CDATA[

			  NO_SECUREITY_LEVEL=0x00;
		      MACONLY= 0x01;
		      MACENC = 0x03;		     
   			this.card.reset(0x05);
		   	//1. Select application         
			this.securityDomain.select("325041592E5359532E4444463031");	 	     
			//2. Open secure channel		    
		   this.openSecureChannel(NO_SECUREITY_LEVEL);    
 
			 this.sendApdu(0X80, 0xE2, 0x80, 0x00,new ByteString("910232A530BF0C2D612B4F07A0000003330101500B50424F43204372656469749F120F4341524420494D4147452030303332870101",HEX));


   			this.card.reset(0x05);
		   	//1. Select application
	 	    // this.securityDomain.select();
	 	    GPSystem.trace("Application id: " + "315041592E5359532E4444463031");
			  this.securityDomain.select("315041592E5359532E4444463031");
	 	     
			//2. Open secure channel
		      //this.openSecureChannel(MACENC);
		     this.openSecureChannel(NO_SECUREITY_LEVEL);
   			this.sendApdu(0X80, 0xE2, 0x00, 0x00,new ByteString("010130702E612C4F08A000000333010101500B50424F43204372656469749F120F4341524420494D4147452030303031870101",HEX));
  			 this.sendApdu(0X80, 0xE2, 0x80, 0x01,new ByteString("910214A5128801015F2D086573656E667264659F110101",HEX));
               ]]></Script>
	</Function>
	
	  <Function Name="allPutKey" Param="myKey,myObject">
		<Script><![CDATA[

			  NO_SECUREITY_LEVEL=0x00;
		      MACONLY= 0x01;
		      MACENC = 0x03;		     
   		 //1. Select pse application
		   //  this.sendApdu(0X00, 0xA4, 0x00, 0x00,new ByteString("3F00",HEX));
			//   this.sendApdu(0XA0, 0x20, 0x00, 0x0B,new ByteString("3634373232323838",HEX));
	 	     
			//this.securityDomain.select("325041592E5359532E4444463031");
			//2. put key
		      //this.putkey(myKey,myObject,NO_SECUREITY_LEVEL);
		   
    		//1. Select ppse application
	 	     //this.securityDomain.select("315041592E5359532E4444463031");
			  //2. put key
		      //this.putkey(myKey,myObject,NO_SECUREITY_LEVEL);
		      
    		//1. Select application
			this.card.reset(0x05);
			//this.sendApdu(0X00, 0xA4, 0x04, 0x00,new ByteString("",HEX));
	 	     this.securityDomain.select("A0000001510000");
			//2. put key
		      this.putkey(myKey,myObject,NO_SECUREITY_LEVEL); 
               ]]></Script>
	</Function>
	
	
<Function Name="putkey" Param="myKey,myObject,level">
		<Script><![CDATA[
			   
			   derivationData = new ByteBuffer();
	       derivationKey = new String();  	      
	      	
	      	this.card.reset(0x05);
				  pan = myObject.PAN;
				  GPSystem.trace("pan:"+pan);
				  randomData = pan.right(6);	
				  GPSystem.trace("randomData :"+ randomData);
	        
	       derivationData.clear();
				 derivationData.append(randomData).append("F001").append(randomData).append("0F01");  
				 GPSystem.trace("derivationData :"+derivationData);
				 Crypto.deriveKey(this.key["KMU"], Crypto.DES_ECB, derivationData.toByteString(), this.key["CDKenc"]);
				 GPSystem.trace("putkey enc :"+ this.key["CDKenc"].getBlob());
			
		
				
			 // this.card.sendApdu(0x00, 0x12, 0x00, 0x00,0x00); 
			//	tempData=new ByteBuffer();
			//	tempData.append("");
				//this.card.sendApdu(0X80, 0xE6, 0x00, 0x02,0x00);
					derivationData =  new ByteBuffer();
					
					derivationData.append("13000000").append(this.key["CDKenc"].getBlob());
					randomData = this.card.sendApdu(0X00, 0x84, 0x00, 0x00,0x08);
					GPSystem.trace("randomData :"+randomData);
					cipher = this.crypto.encrypt(key.Mkey,this.crypto.DES_ECB,derivationData.toByteString());
					GPSystem.trace("cipher :"+cipher);
					derivationData.clear();
					derivationData.append("84D401001C").append(cipher);
					
					mac = this.crypto.sign(key.Mkey,this.crypto.DES_MAC,derivationData.toByteString(),randomData.left(8));
					GPSystem.trace("mac :"+mac);
				  derivationData.clear();
					derivationData.append(cipher).append(mac);
					
					this.sendApdu(0X84, 0xD4, 0x01, 0x00,derivationData.toByteString());
					
					//???
					this.securityDomain.select("315041592E5359532E4444463031");
					
					randomData = this.card.sendApdu(0X00, 0x84, 0x00, 0x00,0x08);
					desData = this.crypto.encrypt(key.Mkey,this.crypto.DES_ECB,randomData.left(8));
					GPSystem.trace("desData :"+desData);
					this.sendApdu(0X00, 0x82, 0x00, 0x00,desData);
					
					
					 derivationData.clear();
					derivationData.append("13000000").append(this.key["CDKenc"].getBlob());
					desDataUpdate = this.crypto.encrypt(key.Mkey,this.crypto.DES_ECB,derivationData.toByteString());
					GPSystem.trace("desDataUpdate :"+desDataUpdate);
					
					rand = this.card.sendApdu(0X00, 0x84, 0x00, 0x00,0x04);
					randData = new ByteBuffer();
					 randData.append(rand.left(4)).append("00000000");
					
					derivationData.clear();
					derivationData.append("84D401001C").append(desDataUpdate);
				  mac = this.crypto.sign(key.Mkey,this.crypto.DES_MAC,derivationData.toByteString(),randData.toByteString());
				  GPSystem.trace("mac2 :"+mac);
				   derivationData.clear();
					derivationData.append(cipher).append(mac);
          this.sendApdu(0X84, 0xD4, 0x01, 0x00,derivationData.toByteString());
         		
      	
      	
      ]]></Script>
	</Function>

<SecureChannel SecureChannel="SCP02" SecurityLevel="C_MAC">
		<OpenSecureChannel Param="level,isFirst">
			<Script><![CDATA[

	            derivationData = new ByteBuffer();
	            derivationKey = new String();
           
	      randomData = this.card.sendApdu(0X00, 0x84, 0x00, 0x00,0x08); 
		    randomData = randomData.left(8);
         this.securityDomain.secureChannel.initializeUpdateV2(0,0,randomData);
  			GPSystem.trace("finish initupdate ");
  			
  		   initResp = new ByteBuffer();  			
  			initResp = this.card.response.bytes(4,6);  
 
				// session enc
				derivationData.clear();
				derivationData.append("0182").append(this.card.response.bytes(12,2)).append("000000000000000000000000");
				Crypto.deriveKey(this.key["KMC"], Crypto.DES_CBC, derivationData.toByteString(), this.key["KSCenc"]);

				// Derive KSCmac
				derivationData.clear();
				derivationData.append("0101").append(this.card.response.bytes(12,2)).append("000000000000000000000000");
				Crypto.deriveKey(this.key["KMC"], Crypto.DES_CBC, derivationData.toByteString(), this.key["KSCmac"]);

					derivationData.clear();							
				derivationData.append("0181").append(this.card.response.bytes(12,2)).append("000000000000000000000000");
				Crypto.deriveKey(this.key["KMC"], Crypto.DES_CBC, derivationData.toByteString(), this.key["KSCkek"]);							
											
	
				// Set the keys used by the secure channel - not sure on KEK key assignments
		
				this.securityDomain.secureChannel.setKekKey(this.key["KSCkek"]);			
				this.securityDomain.secureChannel.setEncKey(this.key["KSCenc"]);
				this.securityDomain.secureChannel.setMacKey(this.key["KSCmac"]);

				this.securityDomain.secureChannel.externalAuthenticateV2(level,0);    
      	    			 
			    

	      ]]></Script>
		</OpenSecureChannel>
	</SecureChannel>

<ScriptFragment Active="true" EndLifeCycle="postPersoPrep" Name="VSDC Data Preparation" StartLifeCycle="prePersoPrep">

<Declaration External="true" Name="dgi0101"/>
<Declaration External="true" Name="dgi0102"/>
<Declaration External="true" Name="dgi0201"/>
<Declaration External="true" Name="dgi0202"/>
<Declaration External="true" Name="dgi0203"/>
<Declaration External="true" Name="dgi0204"/>
<Declaration External="true" Name="dgi0205"/>
<Declaration External="true" Name="dgi0206"/>
<Declaration External="true" Name="dgi0301"/>
<Declaration External="true" Name="dgi0302"/>

<Declaration External="true" Name="dgi0401"/>
<Declaration External="true" Name="dgi0501"/>
<Declaration External="true" Name="dgi0D01"/>

		<Script><![CDATA[
		
		bbICC = new ByteBuffer();
		myObject = this.data;
		 DES = 0x80
		
	
	if (this.data.dgi0101 != "")
		{
			dataValue = this.data.dgi0101;
			GPSystem.trace("dgi0101: "+dataValue );
			dgiTlvList = new TLVList(dataValue,TLV.EMV);
		  	TLV70=dgiTlvList.find(0x70);
			dgiTlvList = new TLVList(TLV70.getValue(),TLV.EMV);
		
			
			//tag57
			TLV57=dgiTlvList.find(0x57);
		 	GPSystem.trace("MyTLV: "+TLV57.getValue());
		 	
		 	this.key["BANKKEK"].setComponent(DES,new ByteString("404142434445464748494a4b4c4d4e4f",HEX));
			decryptData57 = Crypto.decrypt(this.key["BANKKEK"],this.crypto.DES_ECB,TLV57.getValue());
			GPSystem.trace("tag010157 : "+decryptData57 );
		
			dgi0101 = new TLV(0x0101,decryptData57, TLV.DGI);
			bbICC.append(dgi0101.getTLV());           
		}
	if (this.data.dgi0102 != "")
		{
			  dataValue = this.data.dgi0102;
			GPSystem.trace("dgi0102: "+dataValue );
			dgi0102 = new TLV(0x0102,dataValue, TLV.DGI);
			bbICC.append(dgi0102.getTLV());           
		}
		
	if (this.data.dgi0201 != "")
		{
			dataValue = this.data.dgi0201;
			GPSystem.trace("dgi0201: "+dataValue );
			dgi0201 = new TLV(0x0201,dataValue, TLV.DGI);
			bbICC.append(dgi0201.getTLV());               
		}

		myObject.CPS_Output = bbICC.toByteString();		
		]]></Script>
	</ScriptFragment>	
		
	
		<ScriptFragment Active="true" EndLifeCycle="PERSONALIZED" Name="DELETEAPP" StartLifeCycle="post_PersoPrep">
		<Script><![CDATA[
				NO_SECUREITY_LEVEL=0x00;
				MACONLY= 0x01;
				MACENC = 0x03;

				CLA    = 0x80;
				CLASEC = 0x84;

				INS_SelectApplication    = 0xA4;
				INS_Install              = 0xE6;
				INS_InitializeUpdate     = 0x50;
				INS_ExternalAuthenticate = 0x82;
				INS_AppendRecord         = 0xE2;
				INS_PutData              = 0xDA;
				INS_PutKey               = 0xD8;
				INS_ChangePin            = 0x24;
				INS_EndPersonalization    =  0xF0;

				P1 = 0x00;
				P2 = 0x00;

				MyObject=this.data;
				MyKey=this.key;

				GPSystem.trace("The Following is the process of deleteApp");
				GPSystem.trace("current time is: "+ GPSystem.dateTimeByteString().toString());

			//1.Select the Application
				//GP Selecting VSDC Application
				this.securityDomain.select();

		 	//2. card resetto delete the AID
				strATR=this.card.reset(0x05);
				out.println(strATR);

			//3.intializeUpdate and externalAuthenticate,execute the SecureChannel scriptFragment
				this.openSecureChannel(NO_SECUREITY_LEVEL,false);

			//4. delete the AID
				AID=new ByteString("A0000000031010",HEX);
				resp=this.securityDomain.deleteAID(AID,0x9000);

		]]></Script>
	</ScriptFragment>
	
	<ScriptFragment Active="true" EndLifeCycle="PERSONALIZED" Name="ERASE" StartLifeCycle="post_PersoPrep">
		<Script><![CDATA[		

				//MyObject=this.data;
				//MyKey=this.key;
 				//0 native 
				this.card.reset(0x05);
		    	//  this.nativeDel(0x01,0x02);
			

		]]></Script>
	</ScriptFragment>
	
	<ScriptFragment Active="true" EndLifeCycle="PERSONALIZED" Name="INSTALL" StartLifeCycle="post_PersoPrep">
		<Script><![CDATA[
				this.card.reset(0x05);
				this.openSecureChannel(NO_SECUREITY_LEVEL);	 
 			 this.sendApdu(0X80, 0xE6, 0x0C, 0x00,new ByteString("80E60C002708A00000033310101207A00000033310100E315041592E5359532E4444463031011003C9010300",HEX)); 
 			 this.sendApdu(0X80, 0xE6, 0x0C, 0x00,new ByteString("80E60C002708A00000033310101207A00000033310100E325041592E5359532E4444463031011003C9010300",HEX)); 
 			 this.sendApdu(0X80, 0xE6, 0x0C, 0x00,new ByteString("80E60C002108A00000033310101207A000000333101008A000000333010101011003C9010300",HEX)); 

		]]></Script>
	</ScriptFragment>


	
	<ScriptFragment Active="true" EndLifeCycle="PERSONALIZED" Name="PERSONALIZE" StartLifeCycle="post_PersoPrep">
		<Declaration Name="AID"/>
		<Declaration Name="CSN"/>
		<Declaration Name="issuerIIN"/>
		<Declaration Name="dgi0000"/>

		<Key Name="key0" ProfileID="00112233440000000004"/>

		<Script><![CDATA[
                      // Constants used in this fragment
		      NO_SECUREITY_LEVEL=0x00;
		      MACONLY= 0x01;
		      MACENC = 0x03;

		      CLA    = 0x80;
		      CLASEC = 0x84;

		      INS_SelectApplication    = 0xA4;
		      INS_Install    = 0xE6;

		      INS_InitializeUpdate     = 0x50;
		      INS_ExternalAuthenticate = 0x82;
		      INS_AppendRecord         = 0xE2;
		      INS_PutData    = 0xDA;
		      INS_PutKey     = 0xD8;
		      INS_ChangePin  = 0x24;

		      INS_EndPersonalization    =  0xF0;

		      P1 = 0x00;
		      P2 = 0x00;

             
		      myObject=this.data;
		      myKey=this.key;

		dgi8000and9000 = new ByteBuffer();
		    		
				
		CPS_Output=myObject.CPS_Output;
		GPSystem.trace("CPS_Output: "+CPS_Output);
			
		      
		       		//1. Select application
		   this.securityDomain.select("315041592E5359532E4444463031");
	 	   this.securityDomain.select("A000000333010101");	 	  
			//2. Open secure channel
		      this.openSecureChannel(NO_SECUREITY_LEVEL);   
	
		GPSystem.trace("cps output: " + myObject.CPS_Output);
			while(CPS_Output.length>0){
	 			tagPDI = CPS_Output.left(2);

				CPS_Output = CPS_Output.right(CPS_Output.length - 2);
				
				GPSystem.trace("tagPDI : " + tagPDI );	
				//GPSystem.trace("cps output: " + CPS_Output);				
				
				// length of ICC data(PDI data) e.g. 0248
	 			lICC = CPS_Output.left(1);
				CPS_Output = CPS_Output.right(CPS_Output.length - 1);
								
				GPSystem.trace("lICC : " + lICC );
				IccData = CPS_Output.left(lICC.toUnsigned());
				
				CPS_Output = CPS_Output.right(CPS_Output.length - lICC.toUnsigned());
				GPSystem.trace("Append record : ");
				
				
				if(tagPDI=="8000"){
	  		 		GPSystem.trace("IccData8000 : " + IccData );
	  		 		IccData = this.crypto.decrypt(this.key["KEK"],this.crypto.DES_ECB,IccData);	
						GPSystem.trace("decrypt IccData8000 : " + IccData );
	  		  	GPSystem.trace("this.KSCkek: " + this.key["KSCkek"].getBlob() );
	  		   	IccData = this.crypto.encrypt(this.key["KSCkek"],this.crypto.DES_ECB,IccData);	
					//GPSystem.trace("encryptIccData : " + IccData );											
					dataLen = IccData.getL();	
					//dgiTest = new ByteBuffer();
					dgi8000and9000.append(tagPDI);
					dgi8000and9000.append(dataLen.right(1));
					dgi8000and9000.append(IccData);	
				//	encryptedBySkudek(dgiTest.toByteString());	
								
				}else if(tagPDI=="9000"){
					dgi8000and9000.append(tagPDI);
					dgi8000and9000.append(lICC);
					dgi8000and9000.append(IccData);	
					appendRecord8000and9000(dgi8000and9000.toByteString());
				}else if( tagPDI=="8201" || tagPDI=="8202" || tagPDI=="8203" || tagPDI=="8204"||tagPDI=="8205"){
					GPSystem.trace("tag" + tagPDI + ":" + IccData );	  		 		
	  		 		IccData = this.crypto.decrypt(this.key["KEK"],this.crypto.DES_ECB,IccData);	
					GPSystem.trace("decrypt tag" + tagPDI + ":" + IccData );
	  		  		GPSystem.trace("this.KSCkek: " + this.key["KSCkek"].getBlob() );
					IccData = IccData + "80";
					while(IccData.length%16 != 0){
						IccData = IccData + "00";
					}
					IccData=new ByteString(IccData,HEX);
	  		   IccData = this.crypto.encrypt(this.key["KSCkek"],this.crypto.DES_ECB,IccData);	
					//GPSystem.trace("encryptIccData : " + IccData );											
					dataLen = IccData.getL();	
					dgiTest = new ByteBuffer();
					dgiTest.append(tagPDI);
					dgiTest.append(dataLen.right(1));
					dgiTest.append(IccData);	
					encryptedBySkudek(dgiTest.toByteString());  
					
				}else if(tagPDI=="3002"){	
					 dgi = new ByteBuffer();
					 dgi.append(tagPDI);
					 dgi.append(lICC);
					 dgi.append(IccData);
					 endPersonalization(dgi.toByteString());
				}else{
					appendRecord(tagPDI,lICC,IccData);
				}
			}	


			//this.putkey(myKey,myObject,NO_SECUREITY_LEVEL);

			//DGI-END(can't be modified)


         //7.  Send END PERSONALIZATION command to the card
   			//endPersonalization(new ByteString("00",HEX));
   				this.closeSecureChannel();

		]]></Script>
	</ScriptFragment>


</ApplicationProfile>
